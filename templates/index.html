{% extends "base.html" %}
{% block title %}Find Your Perfect Stay - Nestrohotels{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
    :root {
        --font-primary: 'Poppins', sans-serif;
        --font-display: 'Playfair Display', serif;
    }

    .hero-section {
        background: linear-gradient(rgba(0, 20, 30, 0.6), rgba(0, 20, 30, 0.6)), url('https://images.unsplash.com/photo-1535827841776-24e394d38701?auto=format&fit=crop&w=1600&q=80');
        background-size: cover;
        background-position: center;
        padding: 8rem 0;
        color: white;
    }
    .hero-section h1 {
        font-family: var(--font-display);
        font-size: 4rem;
        text-shadow: 0 3px 10px rgba(0,0,0,0.5);
    }

    .search-form-card {
        background-color: rgba(255,255,255,0.9);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 1.5rem;
        padding: 2.5rem;
        margin-top: -5rem;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        position: relative;
        z-index: 10;
        animation: slideUp 0.8s ease-out forwards;
    }
    @keyframes slideUp {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .hotel-card {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }
    .hotel-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 35px rgba(0,0,0,0.1);
    }
    .hotel-card .card-img-container {
        position: relative;
        border-radius: 1rem 1rem 0 0;
        overflow: hidden;
    }
    .hotel-card .card-img-top {
        height: 250px;
        object-fit: cover;
    }
    .hotel-card .card-body {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .hotel-card .amenities-preview {
        display: flex;
        gap: 1rem;
        padding: 0.75rem 0;
        color: #8492a6;
    }
    #map-container {
        position: sticky;
        top: 100px;
    }
    #map {
        height: calc(100vh - 120px);
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content_container %}
<div class="hero-section text-center">
    <div class="container">
        <h1 class="display-3">Discover Your Next Masterpiece</h1>
        <p class="lead" style="font-size: 1.5rem;">Curate unforgettable journeys for your clients.</p>
    </div>
</div>

<div class="container">
    <div class="search-form-card">
        <form method="GET" action="{{ url_for('index') }}">
            <div class="row g-3 align-items-end">
                <div class="col-lg-5">
                    <label for="search_term" class="form-label fw-bold">Destination or Hotel Name</label>
                    <input type="text" class="form-control form-control-lg" id="search_term" name="search_term" placeholder="e.g., Jibhi, Hotel Himalaya" value="{{ search_term or '' }}">
                </div>
                <div class="col-lg-2 col-md-4">
                    <label for="min_price" class="form-label fw-bold">Min Price</label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="number" class="form-control form-control-lg" id="min_price" name="min_price" placeholder="1000" value="{{ min_price or '' }}">
                    </div>
                </div>
                <div class="col-lg-2 col-md-4">
                    <label for="max_price" class="form-label fw-bold">Max Price</label>
                     <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="number" class="form-control form-control-lg" id="max_price" name="max_price" placeholder="5000" value="{{ max_price or '' }}">
                    </div>
                </div>
                <div class="col-lg-1 col-md-4">
                    <label for="star_rating" class="form-label fw-bold">Stars</label>
                    <select class="form-select form-select-lg" id="star_rating" name="star_rating">
                        <option value="">Any</option>
                        <option value="5" {% if star_rating == '5' %}selected{% endif %}>5 ★</option>
                        <option value="4" {% if star_rating == '4' %}selected{% endif %}>4+ ★</option>
                        <option value="3" {% if star_rating == '3' %}selected{% endif %}>3+ ★</option>
                    </select>
                </div>
                <div class="col-lg-2">
                    <button type="submit" class="btn btn-primary btn-lg w-100 py-3"><i class="fas fa-search me-2"></i>Search</button>
                </div>
            </div>
        </form>
    </div>
</div>

<main class="container py-5">
    <div class="row g-5">
        <div class="col-lg-8">
            <h2 class="mb-4" style="font-family: var(--font-display);">Showing {{ hotels|length }} Hotels</h2>
            <div class="row row-cols-1 row-cols-md-2 g-4">
                {% for hotel in hotels %}
                <div class="col">
                    <div class="card hotel-card h-100">
                        <div class="card-img-container">
                            <a href="{{ url_for('hotel_detail', hotel_id=hotel.id) }}">
                                <img src="{{ hotel.image_url|default('https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&w=800&q=80', true) }}" class="card-img-top" alt="{{ hotel.name }}">
                            </a>
                        </div>
                        <div class="card-body p-4">
                            <div>
                                <p class="card-text mb-1 small text-muted">
                                    <i class="fas fa-map-marker-alt me-1"></i>{{ hotel.location }}
                                </p>
                                <h5 class="card-title fw-bold">
                                    <a href="{{ url_for('hotel_detail', hotel_id=hotel.id) }}" class="text-decoration-none text-dark">{{ hotel.name }}</a>
                                </h5>
                                {% if hotel.star_rating %}
                                <div class="mb-2" style="color: #f39c12;">
                                    {% for i in range(hotel.star_rating) %}<i class="fas fa-star"></i>{% endfor %}{% for i in range(5 - hotel.star_rating) %}<i class="far fa-star"></i>{% endfor %}
                                </div>
                                {% endif %}

                                <div class="amenities-preview border-top border-bottom my-3">
                                    {% for amenity in hotel.amenities[:4] %}
                                    <span title="{{ amenity.name }}">
                                        {% if 'Wifi' in amenity.name %}<i class="fas fa-wifi"></i>
                                        {% elif 'Pool' in amenity.name %}<i class="fas fa-swimmer"></i>
                                        {% elif 'Parking' in amenity.name %}<i class="fas fa-parking"></i>
                                        {% elif 'Restaurant' in amenity.name %}<i class="fas fa-utensils"></i>
                                        {% else %}<i class="fas fa-info-circle"></i>{% endif %}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        {% set min_price = hotel.get_min_price() %}
                                        {% if min_price %}
                                            <small class="text-muted">from</small>
                                            <div class="h4 fw-bold mb-0" style="color: var(--primary-color);">₹{{ "%.0f"|format(min_price) }}</div>
                                        {% else %}
                                            <span class="badge bg-secondary">Check Rates</span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        {% if current_user.is_authenticated and current_user.role == 'agent' %}
                                            {% if is_hotel_in_packages(hotel.id) %}
                                                <button class="btn btn-success" disabled><i class="fas fa-check me-2"></i>Added</button>
                                            {% else %}
                                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addToPackageModal-{{ hotel.id }}">
                                                    <i class="fas fa-plus"></i> Add to Proposal
                                                </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if current_user.is_authenticated and current_user.role == 'agent' %}
                    {% include '_add_to_package_modal.html' %}
                {% endif %}
                {% else %}
                <div class="col-12">
                    <div class="alert alert-info text-center p-5">
                        <h4 class="alert-heading">No Hotels Found</h4>
                        <p>Your search did not match any hotels. Please try adjusting your filters or search term.</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="col-lg-4">
            <div id="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>
</main>
{% endblock %}


{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mapData = {{ map_data|tojson|safe }};
        if (mapData && mapData.length > 0) {
            const map = L.map('map');
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            const markers = L.featureGroup();
            mapData.forEach(hotel => {
                const popupContent = `
                    <div style="width: 200px; font-family: var(--font-primary);">
                        <img src="${hotel.imageUrl}" alt="${hotel.name}" style="width:100%; height:100px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;">
                        <h6 class="mb-1 fw-bold"><a href="${hotel.url}" target="_blank" class="text-dark text-decoration-none">${hotel.name}</a></h6>
                        <p class="mb-1 small text-muted">${hotel.location}</p>
                        <strong style="color: var(--primary-color);">from ₹${hotel.price} / night</strong>
                    </div>
                `;
                const marker = L.marker([hotel.lat, hotel.lng]).bindPopup(popupContent);
                markers.addLayer(marker);
            });
            markers.addTo(map);
            if (markers.getBounds().isValid()) {
                map.fitBounds(markers.getBounds().pad(0.2));
            } else if (mapData.length === 1) {
                map.setView([mapData[0].lat, mapData[0].lng], 13);
            }
        } else {
             document.getElementById('map').innerHTML = '<div class="alert alert-warning h-100 d-flex align-items-center justify-content-center text-center">Map data is not available for the current selection.<br><small>Hotels need coordinates to be shown here.</small></div>';
        }
    });
</script>
{% endblock %}
