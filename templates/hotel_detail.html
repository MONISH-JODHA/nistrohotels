{% extends "base.html" %}

{% block title %}{{ hotel.name }} - Hotel Details{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm border-0">
                {# --- Image Carousel --- #}
                {% if carousel_images %} {# carousel_images is now passed from app.py #}
                    <div id="hotelImageCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel">
                        {% if carousel_images|length > 1 %}
                        <div class="carousel-indicators">
                            {% for image_info in carousel_images %}
                                <button type="button" data-bs-target="#hotelImageCarousel" data-bs-slide-to="{{ loop.index0 }}" {% if loop.first %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ loop.index }}"></button>
                            {% endfor %}
                        </div>
                        {% endif %}
                        <div class="carousel-inner" style="border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem;">
                            {% for image_info in carousel_images %}
                            <div class="carousel-item {% if loop.first %}active{% endif %}">
                                <img src="{{ image_info.url }}" class="d-block w-100" alt="{{ image_info.alt }}" style="height: 500px; object-fit: cover;">
                            </div>
                            {% endfor %}
                        </div>
                        {% if carousel_images|length > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#hotelImageCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#hotelImageCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        {% endif %}
                    </div>
                {% else %}
                     <img src="https://via.placeholder.com/800x500.png?text=No+Image+Available" class="card-img-top" alt="No Image Available" style="height: 500px; object-fit: cover; border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem;">
                {% endif %}
                {# --- End Image Carousel --- #}

                <div class="card-body p-4">
                    <h1 class="card-title display-5 mb-2">{{ hotel.name }}</h1>
                    <p class="lead text-muted mb-2"><i class="fas fa-map-marker-alt text-secondary me-2"></i>{{ hotel.location }}</p>
                    {% if hotel.star_rating %}
                        <p class="mb-3 h5 text-warning">
                            {% for i in range(hotel.star_rating) %}<i class="fas fa-star"></i>{% endfor %}{% for i in range(5 - hotel.star_rating) %}<i class="far fa-star"></i>{% endfor %}
                            <span class="ms-2 text-muted small align-middle"> ({{ hotel.star_rating }} Star{{ 's' if hotel.star_rating > 1 }})</span>
                        </p>
                    {% endif %}
                    
                    <h4 class="mt-4 mb-3 text-primary">Description</h4>
                    <p class="text-secondary preserve-newlines">{{ hotel.description if hotel.description else "No description available." }}</p>

                    {% if hotel.get_amenities_list() %}
                    <h4 class="mt-4 mb-3 text-primary">Amenities</h4>
                    <div class="mb-3">
                        {% for amenity in hotel.get_amenities_list() %}
                            <span class="badge bg-info text-dark rounded-pill me-2 mb-2 p-2 px-3 fs-6">{{ amenity }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if hotel.latitude and hotel.longitude %}
                    <h4 class="mt-4 mb-3 text-primary">Location on Map</h4>
                    <div id="singleHotelMap" style="height: 350px; width: 100%; border-radius: 0.375rem;" class="shadow-sm border"></div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top border-0" style="top: 90px;">
                <div class="card-header bg-primary text-white text-center py-3">
                    <h3 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Book Your Stay</h3>
                </div>
                <div class="card-body p-4">
                    <h2 class="text-center mb-4 text-success">${{ "%.2f"|format(hotel.price_per_night) }} <small class="text-muted fs-5">/ night</small></h2>
                    {% if current_user.is_authenticated %}
                        <form method="POST" action="{{ url_for('hotel_detail', hotel_id=hotel.id) }}">
                            <div class="mb-3">
                                <label for="check_in_date" class="form-label fw-bold">Check-in Date</label>
                                <input type="date" class="form-control form-control-lg" id="check_in_date" name="check_in_date" min="{{ today }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="check_out_date" class="form-label fw-bold">Check-out Date</label>
                                <input type="date" class="form-control form-control-lg" id="check_out_date" name="check_out_date" min="{{ today }}" required>
                            </div>
                            <div class="d-grid mt-4">
                                <button type="submit" class="btn btn-success btn-lg py-3"><i class="fas fa-calendar-check me-2"></i> Book Now</button>
                            </div>
                        </form>
                    {% else %}
                        <p class="text-center lead">Please <a href="{{ url_for('login', next=request.url) }}">log in</a> or <a href="{{ url_for('register', next=request.url) }}">register</a> to book.</p>
                        <div class="d-grid gap-2 mt-4">
                             <a href="{{ url_for('login', next=request.url) }}" class="btn btn-primary btn-lg">Login to Book</a>
                             <a href="{{ url_for('register', next=request.url) }}" class="btn btn-outline-secondary btn-lg">Register</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="mt-4 mb-3 text-center">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-lg"><i class="fas fa-arrow-left me-2"></i> Back to All Hotels</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Date picker logic
    const checkInInput = document.getElementById('check_in_date');
    const checkOutInput = document.getElementById('check_out_date');
    const todayDate = "{{ today }}";

    if (checkInInput && checkOutInput) {
        checkInInput.addEventListener('change', function() {
            if (this.value) {
                let nextDay = new Date(this.value);
                nextDay.setDate(nextDay.getDate() + 1);
                checkOutInput.min = nextDay.toISOString().split('T')[0];
                if (checkOutInput.value && checkOutInput.value <= this.value) {
                    checkOutInput.value = checkOutInput.min;
                }
            } else {
                 checkOutInput.min = todayDate;
            }
        });
        if (checkInInput.value) {
            let nextDay = new Date(checkInInput.value);
            nextDay.setDate(nextDay.getDate() + 1);
            checkOutInput.min = nextDay.toISOString().split('T')[0];
        }
    }

    // Single Hotel Map on Detail Page
    {% if hotel.latitude and hotel.longitude %}
    document.addEventListener('DOMContentLoaded', function() {
        const hotelLat = {{ hotel.latitude }};
        const hotelLng = {{ hotel.longitude }};
        const hotelName = {{ hotel.name|tojson|safe }};
        const mapDetailDiv = document.getElementById('singleHotelMap');
        
        if (mapDetailDiv && typeof L !== 'undefined') {
            try {
                const detailMap = L.map('singleHotelMap').setView([hotelLat, hotelLng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(detailMap);
                L.marker([hotelLat, hotelLng]).addTo(detailMap)
                    .bindPopup(`<b>${hotelName}</b><br>${{ hotel.location|tojson|safe }}`)
                    .openPopup();
            } catch (e) {
                console.error("Error initializing single hotel map:", e);
                mapDetailDiv.innerHTML = "<p class='text-center text-danger p-3'>Map could not be loaded.</p>";
            }
        }
    });
    {% endif %}
</script>
{% endblock %}