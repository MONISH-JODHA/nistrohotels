{% extends "base.html" %}
{% block title %}{{ hotel.name }} - Nestrohotels{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    .hotel-gallery img {
        object-fit: cover;
        width: 100%;
        height: 100%;
        border-radius: 12px;
    }
    #map { height: 400px; border-radius: 12px; z-index: 1; }
    .amenity-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 0.4rem 0.9rem;
        border-radius: 20px;
        font-size: 0.9rem;
    }
    .room-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .room-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Hotel Header -->
    <div class="row mb-5">
        <div class="col-lg-8">
            <h1 class="display-5 fw-bold">{{ hotel.name }}</h1>
            <p class="text-muted fs-5"><i class="fas fa-map-marker-alt me-2"></i>{{ hotel.location }}</p>
            {% if hotel.star_rating %}
                <div class="h4" style="color: #f39c12;">
                    {% for i in range(hotel.star_rating) %}<i class="fas fa-star"></i>{% endfor %}{% for i in range(5 - hotel.star_rating) %}<i class="far fa-star text-muted"></i>{% endfor %}
                    <span class="fs-6 text-dark align-middle ms-2">({{ hotel.star_rating }}-Star Hotel)</span>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Gallery -->
    <div class="row g-3 mb-5 hotel-gallery">
        <div class="col-lg-7">
            <img src="{{ hotel.image_url|default('https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&w=1200&q=80', true) }}" alt="Main view of {{ hotel.name }}" style="height: 500px;">
        </div>
        <div class="col-lg-5">
            <div class="row g-3">
                {% set gallery_images = hotel.gallery_images.limit(4).all() %}
                {% for image in gallery_images %}
                    <div class="col-6">
                        <img src="{{ url_for('static', filename='uploads/hotel_images/' + image.filename) }}" alt="Gallery image of {{ hotel.name }}">
                    </div>
                {% endfor %}
                {% if gallery_images|length < 4 %}
                    {% for i in range(4 - gallery_images|length) %}
                    <div class="col-6"><img src="https://images.unsplash.com/photo-1582719508461-905c673771fd?auto=format&fit=crop&w=400&q=80" alt="Placeholder image"></div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Agent Actions Section -->
    {% if current_user.is_authenticated and current_user.role == 'agent' %}
        <div class="card shadow-sm border-0 mb-5">
            <div class="card-body p-4">
                 <!-- THIS IS THE CRITICAL FIX: Replaced remove button with a status or an add form -->
                {% if is_hotel_in_packages(hotel.id) %}
                    <div class="alert alert-success d-flex align-items-center mb-0">
                        <i class="fas fa-check-circle fa-2x me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-0">This hotel is in one or more of your proposals.</h5>
                            <a href="{{ url_for('my_packages') }}" class="fw-bold text-decoration-none">Manage my proposals <i class="fas fa-arrow-right"></i></a>
                        </div>
                    </div>
                {% else %}
                    <h5 class="mb-3">Add to a Client Proposal</h5>
                    <form action="{{ url_for('add_to_packages', hotel_id=hotel.id) }}" method="POST">
                        <div class="input-group">
                            <input type="text" class="form-control" name="package_name" list="package-names" placeholder="Enter new or existing proposal name..." required>
                            <datalist id="package-names">
                                {% for package_name in agent_packages %}
                                <option value="{{ package_name }}">
                                {% endfor %}
                            </datalist>
                            <button class="btn btn-primary" type="submit"><i class="fas fa-plus me-2"></i>Add to Proposal</button>
                        </div>
                         <div class="form-text">You can add this hotel to an existing proposal or create a new one by typing a new name.</div>
                    </form>
                {% endif %}
            </div>
        </div>
    {% endif %}


    <!-- Details and Map -->
    <div class="row g-5">
        <div class="col-lg-8">
            <!-- Description -->
            <section id="description">
                <h3 class="mb-3">About {{ hotel.name }}</h3>
                <p class="lh-lg">{{ hotel.description }}</p>
            </section>
            
            <!-- Amenities -->
            {% set amenities = hotel.get_amenities_list() %}
            {% if amenities %}
                <section id="amenities" class="mt-5">
                    <h3 class="mb-4">Amenities</h3>
                    <div class="d-flex flex-wrap gap-3">
                        {% for amenity in amenities %}
                            <div class="amenity-tag">{{ amenity }}</div>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}

            <!-- Rooms -->
            <section id="rooms" class="mt-5">
                <h3 class="mb-4">Available Room Types</h3>
                {% for room in room_types %}
                <div class="card mb-4 room-card border-0 shadow-sm">
                    <div class="row g-0">
                        <div class="col-md-4">
                            <img src="{{ room.main_image_url }}" class="img-fluid rounded-start" alt="{{ room.name }}" style="height: 100%; object-fit: cover;">
                        </div>
                        <div class="col-md-8">
                            <div class="card-body p-4">
                                <h5 class="card-title">{{ room.name }}</h5>
                                <p class="card-text">{{ room.description }}</p>
                                {% if room.get_amenities_list() %}
                                    <p class="small text-muted mb-3"><strong>Room features:</strong> {{ room.get_amenities_list()|join(', ') }}</p>
                                {% endif %}
                                <div class="d-flex justify-content-between align-items-center">
                                    <p class="h4 fw-bold text-success mb-0">${{ "%.2f"|format(room.price_per_night) }}<span class="fs-6 fw-normal text-muted">/night</span></p>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bookingModal-{{ room.id }}">Book for Client</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Booking Modal for each room -->
                {% include '_booking_modal.html' %}
                {% endfor %}
            </section>

        </div>

        <div class="col-lg-4">
            <div class="sticky-top" style="top: 100px;">
                <h3 class="mb-3">Location</h3>
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if hotel.latitude and hotel.longitude %}
            const map = L.map('map').setView([{{ hotel.latitude }}, {{ hotel.longitude }}], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            L.marker([{{ hotel.latitude }}, {{ hotel.longitude }}]).addTo(map)
                .bindPopup("<b>{{ hotel.name|e }}</b><br>{{ hotel.location|e }}")
                .openPopup();
        {% else %}
            document.getElementById('map').innerHTML = '<div class="alert alert-warning">Location data is not available for this hotel.</div>';
        {% endif %}
    });
</script>
{% endblock %}
