{% extends "base.html" %}
{% block title %}Register Your Hotel - Nestrohotels{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<style>
    body { background-color: #f4f7f9 !important; }
    .register-container {
        max-width: 900px;
        margin: 3rem auto;
        background: #ffffff;
        border-radius: 24px;
        box-shadow: 0 15px 50px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .form-header {
        padding: 2rem;
        text-align: center;
    }
    .form-header h1 {
        font-family: 'Playfair Display', serif;
        font-weight: 700;
    }

    /* Stepper Navigation */
    .stepper {
        display: flex;
        justify-content: space-between;
        padding: 1rem 3rem;
        border-bottom: 1px solid #e9ecef;
    }
    .step {
        display: flex;
        align-items: center;
        flex-direction: column;
        color: #adb5bd;
        font-weight: 600;
        position: relative;
        flex-grow: 1;
    }
    .step .step-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #adb5bd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    .step.active .step-icon {
        background: var(--primary-color);
        color: white;
    }
    .step.active { color: var(--primary-color); }
    .step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        width: 100%;
        height: 2px;
        background-color: #e9ecef;
        z-index: -1;
    }
    
    /* Form Sections */
    .form-section {
        display: none;
        padding: 2.5rem 3rem;
        animation: fadeIn 0.5s ease;
    }
    .form-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Custom Amenities Checkboxes */
    .amenity-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
    }
    .amenity-option input[type="checkbox"] { display: none; }
    .amenity-option label {
        display: block;
        padding: 0.75rem 1rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .amenity-option label:hover {
        border-color: var(--primary-color);
        background-color: #f8f9fa;
    }
    .amenity-option input[type="checkbox"]:checked + label {
        border-color: var(--primary-color);
        background-color: rgba(0, 121, 107, 0.05);
        color: var(--primary-color);
    }
    
    #map { height: 400px; border-radius: 12px; z-index: 1; }

    .form-actions {
        display: flex;
        justify-content: space-between;
        padding: 2rem 3rem;
        border-top: 1px solid #e9ecef;
    }
</style>
{% endblock %}

{% block content %}
<div class="register-container">
    <div class="form-header">
        <h1>Register Your Hotel</h1>
        <p class="lead text-muted">Follow these simple steps to get your property listed.</p>
    </div>

    <div class="stepper">
        <div class="step active" data-step="1">
            <div class="step-icon">1</div>
            <div>Information</div>
        </div>
        <div class="step" data-step="2">
            <div class="step-icon">2</div>
            <div>Location</div>
        </div>
        <div class="step" data-step="3">
            <div class="step-icon">3</div>
            <div>Details</div>
        </div>
        <div class="step" data-step="4">
            <div class="step-icon"><i class="fas fa-check"></i></div>
            <div>Finish</div>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <!-- Step 1: Basic Information -->
        <div class="form-section active" data-step="1">
            <h4 class="mb-4">Basic Information</h4>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Hotel Name *</label>
                    <input type="text" class="form-control form-control-lg" id="name" name="name" required>
                </div>
                <div class="col-md-6">
                    <label for="location" class="form-label">Location (City, Country) *</label>
                    <input type="text" class="form-control form-control-lg" id="location" name="location" required>
                </div>
                <div class="col-12">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="5"></textarea>
                </div>
            </div>
        </div>

        <!-- Step 2: Location on Map -->
        <div class="form-section" data-step="2">
            <h4 class="mb-2">Pinpoint Your Location</h4>
            <p class="text-muted mb-3">Search for your hotel's address or click on the map to place a pin. This will auto-fill the coordinates.</p>
            <div id="map"></div>
            <div class="row g-3 mt-3">
                <div class="col-md-6">
                    <label for="latitude" class="form-label">Latitude</label>
                    <input type="text" class="form-control" id="latitude" name="latitude" readonly>
                </div>
                <div class="col-md-6">
                    <label for="longitude" class="form-label">Longitude</label>
                    <input type="text" class="form-control" id="longitude" name="longitude" readonly>
                </div>
            </div>
        </div>

        <!-- Step 3: Amenities & Photos -->
        <div class="form-section" data-step="3">
            <h4 class="mb-4">Amenities, Images & Rating</h4>
            <div class="row g-5">
                <div class="col-lg-7">
                    <h5>Amenities</h5>
                    <div class="amenity-grid mt-3">
                        {% for amenity in all_amenities %}
                        <div class="amenity-option">
                            <input class="form-check-input" type="checkbox" name="amenities" value="{{ amenity.id }}" id="amenity_{{ amenity.id }}">
                            <label class="form-check-label" for="amenity_{{ amenity.id }}">{{ amenity.name }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-lg-5">
                     <h5>Images & Rating</h5>
                    <div class="mb-3">
                        <label for="main_image_url" class="form-label">Main Image (URL)</label>
                        <input type="url" class="form-control" id="main_image_url" name="main_image_url" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="mb-3">
                        <label for="gallery_images_upload" class="form-label">Or Upload Gallery Images</label>
                        <input class="form-control" type="file" id="gallery_images_upload" name="gallery_images_upload" multiple>
                    </div>
                    <div class="mb-3">
                        <label for="star_rating" class="form-label">Star Rating</label>
                        <select class="form-select" id="star_rating" name="star_rating">
                            <option value="" selected>Select a rating</option>
                            <option value="1">1 Star</option><option value="2">2 Stars</option>
                            <option value="3">3 Stars</option><option value="4">4 Stars</option>
                            <option value="5">5 Stars</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div class="form-section text-center" data-step="4">
            <div class="py-5">
                <i class="fas fa-check-circle text-success fa-4x mb-4"></i>
                <h2 class="fw-bold">Ready to Submit?</h2>
                <p class="lead text-muted">Click the button below to submit your hotel for review by our team.</p>
                <button type="submit" class="btn btn-primary btn-lg px-5 py-3 mt-3">Submit for Approval</button>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="form-actions">
            <button type="button" class="btn btn-secondary btn-lg" id="prevBtn" style="display: none;">Previous</button>
            <button type="button" class="btn btn-primary btn-lg" id="nextBtn">Next</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentStep = 1;
        const totalSteps = 4;
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const submitBtn = document.querySelector('button[type="submit"]');

        const latInput = document.getElementById('latitude');
        const lonInput = document.getElementById('longitude');
        const locationInput = document.getElementById('location');

        let map, marker, geocoder;
        
        function updateStepView() {
            document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
            document.querySelector(`.form-section[data-step="${currentStep}"]`).classList.add('active');

            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');

            prevBtn.style.display = currentStep > 1 ? 'inline-block' : 'none';
            nextBtn.style.display = currentStep < totalSteps ? 'inline-block' : 'none';
            
            if (currentStep === 2 && !map) {
                initializeMap();
            }
        }

        function initializeMap() {
            map = L.map('map').setView([20.5937, 78.9629], 5); // Default view over India
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap © CARTO'
            }).addTo(map);

            geocoder = L.Control.geocoder({
                defaultMarkGeocode: false,
                placeholder: 'Search for a location...'
            }).on('markgeocode', function(e) {
                const bbox = e.geocode.bbox;
                const latlng = e.geocode.center;
                map.fitBounds(bbox);
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker(latlng).addTo(map).bindPopup(e.geocode.name).openPopup();
                updateFormFields(latlng, e.geocode.name);
            }).addTo(map);

            map.on('click', function(e) {
                const latlng = e.latlng;
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker(latlng).addTo(map);
                updateFormFields(latlng, `Lat: ${latlng.lat.toFixed(4)}, Lng: ${latlng.lng.toFixed(4)}`);
            });
        }
        
        function updateFormFields(latlng, name) {
            latInput.value = latlng.lat.toFixed(6);
            lonInput.value = latlng.lng.toFixed(6);
            // Optionally update the location name input if it's the first time
            if (!locationInput.value && !name.startsWith('Lat:')) {
                locationInput.value = name.split(',').slice(0, 2).join(', ');
            }
        }

        nextBtn.addEventListener('click', () => {
            if (currentStep < totalSteps) {
                currentStep++;
                updateStepView();
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 1) {
                currentStep--;
                updateStepView();
            }
        });

        updateStepView(); // Initial call
    });
</script>
{% endblock %}
