{% extends "base.html" %}
{% block title %}My Proposals - Nestrohotels{% endblock %}

{% block head_extra %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-color: #00796B;
        --secondary-color: #0a9396;
        --success-color: #2a9d8f;
        --danger-color: #ae2012;
        --bg-body: #f4f7f9;
        --bg-card: #ffffff;
        --text-dark: #212529;
        --text-light: #6c757d;
        --border-color: #e9ecef;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
        --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
    }
    body {
        background-color: var(--bg-body) !important;
        font-family: 'Poppins', sans-serif;
    }
    .page-header h1 { color: var(--primary-color); font-weight: 700; }
    .package-group {
        background-color: var(--bg-card);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-md);
        margin-bottom: 2.5rem;
    }
    .package-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .package-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); margin: 0; }
    .package-notes {
        font-size: 0.95rem;
        color: var(--text-light);
        padding: 1rem 2rem;
        background-color: #fcfdfe;
    }
    .hotel-card {
        display: flex;
        gap: 1.5rem;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
    }
    .hotel-card:last-child { border-bottom: none; }
    .hotel-card:hover { background-color: #f8f9fa; }
    .hotel-img { width: 120px; height: 90px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
    .hotel-name { font-weight: 600; font-size: 1.1rem; color: var(--text-dark); }
    .hotel-location { font-size: 0.9rem; color: var(--text-light); }
    .empty-state { text-align: center; padding: 4rem 2rem; background-color: var(--bg-card); border-radius: 16px; }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-5 page-header">
        <div>
            <h1 class="mb-1"><i class="fas fa-folder-open me-2"></i>My Client Proposals</h1>
            <p class="text-muted fs-5">Curate and share hotel collections with your clients.</p>
        </div>
        <a href="{{ url_for('index') }}" class="btn btn-lg btn-outline-primary rounded-pill"><i class="fas fa-plus me-2"></i> Add Hotels to a New Proposal</a>
    </div>

    {% if packages %}
        {% for name, package_data in packages.items() %}
        <div class="package-group">
            <div class="package-header">
                <h2 class="package-title">{{ name }}</h2>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editPackageModal" data-package-name="{{ name }}" data-package-notes="{{ package_data.notes or '' }}">
                        <i class="fas fa-edit me-2"></i>Edit
                    </button>
                    <a href="{{ url_for('share_proposal', agent_id=current_user.id, package_name_url=name|url_safe) }}" class="btn btn-info text-white" target="_blank">
                        <i class="fas fa-share-square me-2"></i>Share Link
                    </a>
                    <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deletePackageModal" data-package-name="{{ name }}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>

            {% if package_data.notes %}
                <div class="package-notes">
                    <p class="mb-0"><strong>Notes for Client:</strong> {{ package_data.notes }}</p>
                </div>
            {% endif %}

            <div class="package-hotels-list">
                {% for item in package_data.hotels %}
                <div class="hotel-card">
                    <img src="{{ item.hotel.image_url|default('https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&w=800&q=80', true) }}" alt="{{ item.hotel.name }}" class="hotel-img">
                    <div class="flex-grow-1">
                        <h5 class="hotel-name">{{ item.hotel.name }}</h5>
                        <p class="hotel-location mb-2"><i class="fas fa-map-marker-alt me-1"></i>{{ item.hotel.location }}</p>
                        <a href="{{ url_for('hotel_detail', hotel_id=item.hotel.id) }}" class="btn btn-sm btn-outline-dark">View Details</a>
                    </div>
                    <!-- THIS IS THE CRITICAL FIX: The form action now uses 'package_id' -->
                    <form action="{{ url_for('remove_from_packages', package_id=item.id) }}" method="POST">
                        <button type="submit" class="btn btn-sm btn-light text-danger" title="Remove from this package"><i class="fas fa-times"></i></button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <i class="fas fa-hotel fa-4x text-light mb-4"></i>
            <h2 class="fw-bold text-dark">Your proposal list is empty.</h2>
            <p class="lead text-muted mb-4">Start by finding hotels and adding them to a new proposal for your clients.</p>
            <a href="{{ url_for('index') }}" class="btn btn-lg btn-primary rounded-pill px-5 py-3"><i class="fas fa-search me-2"></i>Find Hotels</a>
        </div>
    {% endif %}
</div>

<!-- Edit Package Modal -->
<div class="modal fade" id="editPackageModal" tabindex="-1" aria-labelledby="editPackageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPackageModalLabel">Edit Proposal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('edit_package') }}" method="POST">
        <div class="modal-body">
            <input type="hidden" name="old_package_name" id="oldPackageName">
            <div class="mb-3">
                <label for="newPackageName" class="form-label">Proposal Name</label>
                <input type="text" class="form-control" id="newPackageName" name="new_package_name" required>
            </div>
            <div class="mb-3">
                <label for="packageNotes" class="form-label">Notes for Client</label>
                <textarea class="form-control" id="packageNotes" name="notes" rows="4" placeholder="e.g., A selection of luxury beach-front resorts for your honeymoon."></textarea>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Package Modal -->
<div class="modal fade" id="deletePackageModal" tabindex="-1" aria-labelledby="deletePackageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePackageModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('delete_package') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="package_name_to_delete" id="packageNameToDelete">
                    <p>Are you sure you want to delete the entire proposal "<strong id="deletePackageNameDisplay"></strong>"? This will remove all hotels from this collection and cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger"><i class="fas fa-trash-alt me-2"></i>Yes, Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const editModal = document.getElementById('editPackageModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const packageName = button.getAttribute('data-package-name');
            const packageNotes = button.getAttribute('data-package-notes');
            
            const modalTitle = editModal.querySelector('.modal-title');
            const oldNameInput = editModal.querySelector('#oldPackageName');
            const newNameInput = editModal.querySelector('#newPackageName');
            const notesInput = editModal.querySelector('#packageNotes');
            
            modalTitle.textContent = 'Edit Proposal: ' + packageName;
            oldNameInput.value = packageName;
            newNameInput.value = packageName;
            notesInput.value = packageNotes;
        });
    }

    const deleteModal = document.getElementById('deletePackageModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const packageName = button.getAttribute('data-package-name');
            
            deleteModal.querySelector('#packageNameToDelete').value = packageName;
            deleteModal.querySelector('#deletePackageNameDisplay').textContent = packageName;
        });
    }
});
</script>
{% endblock %}
